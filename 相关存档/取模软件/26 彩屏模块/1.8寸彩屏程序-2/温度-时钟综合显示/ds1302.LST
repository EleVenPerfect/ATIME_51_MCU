C51 COMPILER V7.10   DS1302                                                                05/04/2011 17:33:47 PAGE 1   


C51 COMPILER V7.10, COMPILATION OF MODULE DS1302
OBJECT MODULE PLACED IN ds1302.OBJ
COMPILER INVOKED BY: C:\Keil\C51\BIN\C51.EXE ds1302.c BROWSE DEBUG OBJECTEXTEND

line level    source

   1          /*******************************************************************************
   2          *  ±êÌâ:  ÊÔÑéÊýÂë¹ÜÏÔÊ¾Ê±ÖÓ                                                   *
   3          *                                                                                                                                                          *
   4          * Í¨¹ý±¾Àý³ÌÁË½â DS1302Ê±ÖÓÐ¾Æ¬µÄ»ù±¾Ô­ÀíºÍÊ¹ÓÃ ,Àí½â²¢ÕÆÎÕDS1302Ê±ÖÓÐ¾Æ¬          *
   5          * Çý¶¯³ÌÐòµÄ±àÐ´ÒÔ¼°ÊµÏÖÊý×Ö×Ö·ûÔÚÊýÂë¹ÜÖÐµÄÏÔÊ¾¡£                                                         *
   6          * ×¢Òâ£ºJP1302ÌøÏßÃ°Òª¶Ì½Ó¡£                                                   *
   7          * ÇëÑ§Ô±ÈÏÕæÏû»¯±¾Àý³Ì£¬¶®DS1302ÔÚCÓïÑÔÖÐµÄ²Ù×÷                                *
   8          ********************************************************************************/
   9          #include<reg52.h> //°üº¬Í·ÎÄ¼þ£¬Ò»°ãÇé¿ö²»ÐèÒª¸Ä¶¯£¬Í·ÎÄ¼þ°üº¬ÌØÊâ¹¦ÄÜ¼Ä´æÆ÷µÄ¶¨Òå
  10          #include <intrins.h>
  11          
  12          sbit SCK = P3^6;        //Ê±ÖÓ  
  13          sbit SDA = P3^4;        //Êý¾Ý  
  14          sbit RST = P3^5;// DS1302¸´Î»
  15          
  16          
  17          unsigned char l_tmpdate[7]={0,0,12,15,5,3,8};//Ãë·ÖÊ±ÈÕÔÂÖÜÄê08-05-15 12:00:00
  18          unsigned char xdata D[8];
  19          
  20          code unsigned char write_rtc_address[7]={0x80,0x82,0x84,0x86,0x88,0x8a,0x8c}; //Ãë·ÖÊ±ÈÕÔÂÖÜÄê ×îµÍÎ»¶ÁÐ´Î
             -»
  21          code unsigned char read_rtc_address[7]={0x81,0x83,0x85,0x87,0x89,0x8b,0x8d};  
  22          
  23          
  24          /******************************************************************/
  25          /*                    º¯ÊýÉùÃ÷                                    */
  26          /******************************************************************/                                                                                            
  27          void Write_Ds1302_byte(unsigned char temp); 
  28          void Write_Ds1302( unsigned char address,unsigned char dat );
  29          unsigned char Read_Ds1302 ( unsigned char address );
  30          void Read_RTC(void);//read RTC 
  31          void Set_RTC(void); //set RTC 
  32          
  33          
  34          /******************************************************************/
  35          /*                   Ð´Ò»¸ö×Ö½Ú                                   */
  36          /******************************************************************/
  37          void Write_Ds1302_Byte(unsigned  char temp) 
  38          {
  39   1       unsigned char i;
  40   1       for (i=0;i<8;i++)      //Ñ­»·8´Î Ð´ÈëÊý¾Ý
  41   1        { 
  42   2         SCK=0;
  43   2           SDA=temp&0x01;     //Ã¿´Î´«ÊäµÍ×Ö½Ú 
  44   2           temp>>=1;                  //ÓÒÒÆÒ»Î»
  45   2           SCK=1;
  46   2         }
  47   1      }   
  48          /******************************************************************/
  49          /*                  Ð´ÈëDS1302                                    */
  50          /******************************************************************/
  51          void Write_Ds1302( unsigned char address,unsigned char dat )     
  52          {
  53   1              RST=0;
  54   1              _nop_();
C51 COMPILER V7.10   DS1302                                                                05/04/2011 17:33:47 PAGE 2   

  55   1              SCK=0;
  56   1              _nop_();
  57   1              RST=1;  
  58   1              _nop_();                    //Æô¶¯
  59   1              Write_Ds1302_Byte(address);     //·¢ËÍµØÖ·
  60   1              Write_Ds1302_Byte(dat);         //·¢ËÍÊý¾Ý
  61   1              RST=0;                              //»Ö¸´
  62   1      }
  63          /******************************************************************/
  64          /*                   ¶Á³öDS1302Êý¾Ý                               */
  65          /******************************************************************/
  66          unsigned char Read_Ds1302 ( unsigned char address )
  67          {
  68   1              unsigned char i,temp=0x00;
  69   1              RST=0;
  70   1              _nop_();
  71   1              _nop_();
  72   1              SCK=0;
  73   1              _nop_();
  74   1              _nop_();
  75   1              RST=1;
  76   1              _nop_();
  77   1              _nop_();
  78   1              Write_Ds1302_Byte(address);
  79   1              for (i=0;i<8;i++)               //Ñ­»·8´Î ¶ÁÈ¡Êý¾Ý
  80   1              {               
  81   2                      if(SDA)
  82   2                      temp|=0x80;                     //Ã¿´Î´«ÊäµÍ×Ö½Ú
  83   2                      SCK=0;
  84   2                      temp>>=1;                       //ÓÒÒÆÒ»Î»
  85   2                      _nop_();
  86   2                 _nop_();
  87   2                 _nop_();
  88   2                      SCK=1;
  89   2              } 
  90   1              RST=0;
  91   1              _nop_();                        //ÒÔÏÂÎªDS1302¸´Î»µÄÎÈ¶¨Ê±¼ä
  92   1              _nop_();
  93   1              RST=0;
  94   1              SCK=0;
  95   1              _nop_();
  96   1              _nop_();
  97   1              _nop_();
  98   1              _nop_();
  99   1              SCK=1;
 100   1              _nop_();
 101   1              _nop_();
 102   1              SDA=0;
 103   1              _nop_();
 104   1              _nop_();
 105   1              SDA=1;
 106   1              _nop_();
 107   1              _nop_();
 108   1              return (temp);                  //·µ»Ø
 109   1      }
 110          /******************************************************************/
 111          /*                   ¶ÁÊ±ÖÓÊý¾Ý                                   */
 112          /******************************************************************/
 113          void Read_RTC(void)             //¶ÁÈ¡ ÈÕÀú
 114          {
 115   1       unsigned char i,*p;
 116   1       p=read_rtc_address;        //µØÖ·´«µÝ
C51 COMPILER V7.10   DS1302                                                                05/04/2011 17:33:47 PAGE 3   

 117   1       for(i=0;i<7;i++)                   //·Ö7´Î¶ÁÈ¡ Ãë·ÖÊ±ÈÕÔÂÖÜÄê
 118   1       {
 119   2        D[i]=Read_Ds1302(*p);
 120   2        p++;
 121   2       }
 122   1      }
 123          /******************************************************************/
 124          /*                  Éè¶¨Ê±ÖÓÊý¾Ý                                  */
 125          /******************************************************************/
 126          void Set_RTC(void)                  //Éè¶¨ ÈÕÀú
 127          {
 128   1              unsigned char i,*p,tmp;
 129   1              for(i=0;i<7;i++){       //BCD´¦Àí
 130   2                      tmp=l_tmpdate[i]/10;
 131   2                      l_tmpdate[i]=l_tmpdate[i]%10;
 132   2                      l_tmpdate[i]=l_tmpdate[i]+tmp*16;
 133   2              }  
 134   1              Write_Ds1302(0x8E,0X00);
 135   1              
 136   1              p=write_rtc_address;    //´«µØÖ·        
 137   1              for(i=0;i<7;i++)                //7´ÎÐ´Èë Ãë·ÖÊ±ÈÕÔÂÖÜÄê
 138   1              {
 139   2                        Write_Ds1302(*p,l_tmpdate[i]);
 140   2                       p++;  
 141   2               }
 142   1               Write_Ds1302(0x8E,0x80);
 143   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    227    ----
   CONSTANT SIZE    =     14    ----
   XDATA SIZE       =      8    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =      7    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
